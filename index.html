<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HALL 1 - Mapa Interactivo IFA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --verde-base: #2ecc71;
            --verde-sport: #00ffb4;
            --rojo-sold: #e74c3c;
            --fuente: 'Inter', sans-serif;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #f0f0f0; font-family: var(--fuente); }
        
        /* Viewport estático con scroll estándar */
        #viewport { 
            width: 100vw; 
            height: 100vh; 
            overflow: auto; 
            display: block; 
            cursor: default;
        }

        #container { 
            position: relative; 
            transform-origin: 0 0; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: inline-block; 
        }

        img { width: 10169px; height: auto; display: block; image-rendering: high-quality; }

        /* Estilos de las Mesas */
        .mesa { 
            position: absolute; 
            border: 2px solid var(--verde-base); 
            background: rgba(46, 204, 113, 0.25); 
            box-sizing: border-box; 
            z-index: 10; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        .mesa.sport { border-color: var(--verde-sport); background: rgba(0, 255, 180, 0.25); }
        
        /* Estado Agotado */
        .mesa.agotada {
            background: rgba(231, 76, 60, 0.4) !important;
            border-color: var(--rojo-sold) !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .mesa:hover:not(.agotada) { background: rgba(46, 204, 113, 0.7); border-color: #fff; box-shadow: 0 0 30px var(--verde-base); z-index: 100; }
        
        /* Tooltip Premium */
        .mesa::after { 
            content: attr(data-info); 
            position: absolute; 
            bottom: 150%; 
            left: 50%; 
            transform: translateX(-50%) translateY(10px); 
            background: #000; 
            color: #fff; 
            padding: 15px 30px; 
            border-radius: 12px; 
            font-weight: 900; 
            font-size: 38px; 
            white-space: nowrap; 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.2s ease; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            border: 3px solid var(--verde-base); 
            z-index: 1000; 
        }
        .mesa.sport::after { border-color: var(--verde-sport); }
        .mesa.agotada::after { content: attr(data-info) " - VENDIDA"; background: var(--rojo-sold); border-color: #fff; }
        .mesa:hover::after { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* CONTROLES ELEGANTES */
        .controls-wrapper { 
            position: fixed; 
            bottom: 25px; 
            right: 25px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            z-index: 2000; 
            align-items: flex-end;
        }

        .joystick { 
            display: grid; 
            grid-template-columns: repeat(3, 45px); 
            gap: 6px; 
            background: rgba(255,255,255,0.95); 
            padding: 12px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 35px rgba(0,0,0,0.15); 
        }

        .zoom-pill { 
            display: flex; 
            gap: 8px; 
            background: rgba(255,255,255,0.95); 
            padding: 10px; 
            border-radius: 20px; 
            backdrop-filter: blur(10px); 
            box-shadow: 0 10px 35px rgba(0,0,0,0.15); 
        }

        .nav-btn, .action-btn { 
            width: 45px; 
            height: 45px; 
            border: none; 
            background: #fff; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: 900;
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .nav-btn:hover, .action-btn:hover { background: var(--verde-base); color: #fff; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3); }
        .action-btn:active { transform: translateY(0); }
        .fit-text { font-size: 10px; letter-spacing: 1px; }

    </style>
</head>
<body>
    <div id="viewport">
        <div id="container">
            <img src="Hall 1.png" alt="Plano Hall 1">
            <div id="capa-mesas"></div> 
        </div>
    </div>

    <div class="controls-wrapper">
        <div class="joystick">
            <button class="nav-btn" style="grid-column:2" onclick="move('up')">↑</button>
            <button class="nav-btn" style="grid-column:1; grid-row:2" onclick="move('left')">←</button>
            <button class="nav-btn" style="grid-column:3; grid-row:2" onclick="move('right')">→</button>
            <button class="nav-btn" style="grid-column:2; grid-row:3" onclick="move('down')">↓</button>
        </div>
        <div class="zoom-pill">
            <button class="action-btn" onclick="zoom(1.4)">＋</button>
            <button class="action-btn" onclick="zoom(0.7)">－</button>
            <button class="action-btn fit-text" onclick="fit()">FIT</button>
        </div>
    </div>

<script>
    let scale = 1;
    const container = document.getElementById('container');
    const viewport = document.getElementById('viewport');

    // --- SISTEMA DE CARGA Y BARRIDO TOTAL OPTIMIZADO ---
    async function cargarMesas() {
        try {
            // 1. Cargamos el HTML de las mesas localmente
            const respHTML = await fetch('mesas.html');
            const html = await respHTML.text();
            document.getElementById('capa-mesas').innerHTML = html;
            console.log("Capa de mesas cargada localmente.");

            // Ajustamos el mapa a la pantalla de inmediato
            fit();

            // 2. Iniciamos el barrido de zonas en segundo plano
            sincronizarBarridoCompleto(); 
        } catch (e) { 
            console.error("Error cargando mesas.html:", e); 
        }
    }

    async function sincronizarBarridoCompleto() {
        console.log("Iniciando barrido total de sillas desde Shopify...");
        const proxy = 'https://corsproxy.io/?';
        
        // IDs reales de tus variantes para forzar la carga de cada zona
        const zonas = [
            { id: 56503013278028, prefijo: "TCG-A" },
            { id: 56578894725452, prefijo: "TCG-B" },
            { id: 56578895479116, prefijo: "TCG-C" },
            { id: 56578895053132, prefijo: "TCG-D" },
            { id: 56578896036172, prefijo: "TCG-E" },
            { id: 56578896494924, prefijo: "TCG-F" },
            { id: 56578897477964, prefijo: "TCG-G" },
            { id: 56578897805644, prefijo: "TCG-H" },
            { id: 56578897838412, prefijo: "TCG-I" },
            { id: 56578897969484, prefijo: "TCG-J" },
            { id: 56578898264396, prefijo: "TCG-K" },
            { id: 56578898788684, prefijo: "TCG-L" },
            { id: 56578899247436, prefijo: "TCG-M" },
            { id: 56578899738956, prefijo: "TCG-N" },
            { id: 56578900230476, prefijo: "SPORT CARDS-A" },
            { id: 56578900328780, prefijo: "SPORT CARDS-B" },
            { id: 56578900361548, prefijo: "SPORT CARDS-C" },
            { id: 56578900590924, prefijo: "SPORT CARDS-D" },
            { id: 56578901082444, prefijo: "SPORT CARDS-E" },
            { id: 56579214311756, prefijo: "SPORT CARDS-F" }
        ];

        // Ejecutamos las peticiones en paralelo para que el barrido dure pocos segundos
        const promesas = zonas.map(async (zona) => {
            try {
                // Forzamos la variante en la URL para que Evey nos devuelva esos asientos específicos
                const urlTienda = encodeURIComponent(`https://frikimonkey.com/products/icons-26-vendor-pass?variant=${zona.id}`);
                const response = await fetch(proxy + urlTienda);
                const text = await response.text();
                const doc = new DOMParser().parseFromString(text, 'text/html');

                // Buscamos el selector de asientos inyectado por Evey
                const opciones = doc.querySelectorAll('.seat-select option');

                opciones.forEach(opt => {
                    const texto = opt.textContent.trim().toLowerCase();
                    const numeroMesa = texto.split(' ')[0];
                    // Detectamos si el asiento está bloqueado o vendido
                    const estaAgotado = opt.hasAttribute('disabled') || texto.includes('sold out');

                    if (estaAgotado) {
                        // Construimos el ID exacto que tienes en mesas.html (ej: TCG-A-1)
                        const mesaID = `${zona.prefijo}-${numeroMesa}`;
                        const mesaElement = document.querySelector(`.mesa[data-info="${mesaID}"]`);
                        
                        if (mesaElement) {
                            mesaElement.classList.add('agotada');
                        }
                    }
                });
            } catch (e) {
                console.error(`Error escaneando zona ${zona.prefijo}:`, e);
            }
        });

        // Esperamos a que todas las consultas terminen
        await Promise.all(promesas);
        console.log("Sincronización total con Shopify completada.");
    }

    // --- FUNCIONES DE NAVEGACIÓN ---
    function zoom(f) { 
        let newScale = scale * f;
        if (newScale >= 0.01 && newScale <= 0.8) {
            scale = newScale;
            container.style.transform = `scale(${scale})`; 
        }
    }

    function move(dir) {
        const step = 300;
        if(dir === 'up') viewport.scrollTop -= step;
        if(dir === 'down') viewport.scrollTop += step;
        if(dir === 'left') viewport.scrollLeft -= step;
        if(dir === 'right') viewport.scrollLeft += step;
    }

    function fit() { 
        // 10169px es el ancho original de tu Hall 1.png
        scale = (window.innerWidth / 10169) * 0.8; 
        container.style.transform = `scale(${scale})`;
        viewport.scrollTo(0,0);
    }

    window.onload = cargarMesas;
    window.onresize = fit;
</script>
</body>
</html>
